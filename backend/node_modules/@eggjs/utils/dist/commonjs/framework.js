"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFrameworkPath = getFrameworkPath;
const node_util_1 = require("node:util");
const node_path_1 = __importDefault(require("node:path"));
const node_assert_1 = __importDefault(require("node:assert"));
const node_fs_1 = require("node:fs");
const utils_js_1 = require("./utils.js");
const import_js_1 = require("./import.js");
const debug = (0, node_util_1.debuglog)('@eggjs/utils/framework');
const initCwd = process.cwd();
/**
 * Find the framework directory, lookup order
 * - specify framework path
 * - get framework name from
 * - use egg by default
 * @param {Object} options - options
 * @param  {String} options.baseDir - the current directory of application
 * @param  {String} [options.framework] - the directory of framework
 * @return {String} frameworkPath
 */
function getFrameworkPath(options) {
    const { framework, baseDir } = options;
    const pkgPath = node_path_1.default.join(baseDir, 'package.json');
    (0, node_assert_1.default)((0, node_fs_1.existsSync)(pkgPath), `${pkgPath} should exist`);
    const moduleDir = node_path_1.default.join(baseDir, 'node_modules');
    // 1. pass framework or customEgg
    if (framework) {
        // 1.1 framework is an absolute path
        // framework: path.join(baseDir, 'node_modules/${frameworkName}')
        if (node_path_1.default.isAbsolute(framework)) {
            (0, node_assert_1.default)((0, node_fs_1.existsSync)(framework), `${framework} should exist`);
            return framework;
        }
        // 1.2 framework is a npm package that required by application
        // framework: 'frameworkName'
        return assertAndReturn(framework, moduleDir);
    }
    const pkg = (0, utils_js_1.readJSONSync)(pkgPath);
    // 2. framework is not specified
    // 2.1 use framework name from pkg.egg.framework
    if (pkg.egg?.framework) {
        return assertAndReturn(pkg.egg.framework, moduleDir);
    }
    // 2.2 use egg by default
    return assertAndReturn('egg', moduleDir);
}
function assertAndReturn(frameworkName, moduleDir) {
    const moduleDirs = new Set([
        moduleDir,
        // find framework from process.cwd, especially for test,
        // the application is in test/fixtures/app,
        // and framework is install in ${cwd}/node_modules
        node_path_1.default.join(process.cwd(), 'node_modules'),
        // prevent from mocking process.cwd
        node_path_1.default.join(initCwd, 'node_modules'),
    ]);
    try {
        // find framework from global, especially for monorepo
        let globalModuleDir;
        // if frameworkName is scoped package, like @ali/egg
        if (frameworkName.startsWith('@') && frameworkName.includes('/')) {
            globalModuleDir = node_path_1.default.join((0, import_js_1.importResolve)(`${frameworkName}/package.json`), '../../..');
        }
        else {
            globalModuleDir = node_path_1.default.join((0, import_js_1.importResolve)(`${frameworkName}/package.json`), '../..');
        }
        moduleDirs.add(globalModuleDir);
    }
    catch (err) {
        // ignore
        debug('importResolve %s on %s error: %s', frameworkName, moduleDir, err);
    }
    for (const moduleDir of moduleDirs) {
        const frameworkPath = node_path_1.default.join(moduleDir, frameworkName);
        if ((0, node_fs_1.existsSync)(frameworkPath))
            return frameworkPath;
    }
    throw new Error(`${frameworkName} is not found in ${Array.from(moduleDirs)}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWV3b3JrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ZyYW1ld29yay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQTBCQSw0Q0E0QkM7QUF0REQseUNBQXFDO0FBQ3JDLDBEQUE2QjtBQUM3Qiw4REFBaUM7QUFDakMscUNBQXFDO0FBQ3JDLHlDQUEwQztBQUMxQywyQ0FBNEM7QUFFNUMsTUFBTSxLQUFLLEdBQUcsSUFBQSxvQkFBUSxFQUFDLHdCQUF3QixDQUFDLENBQUM7QUFFakQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBTzlCOzs7Ozs7Ozs7R0FTRztBQUNILFNBQWdCLGdCQUFnQixDQUFDLE9BQWdCO0lBQy9DLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEdBQUcsT0FBTyxDQUFDO0lBQ3ZDLE1BQU0sT0FBTyxHQUFHLG1CQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNuRCxJQUFBLHFCQUFNLEVBQUMsSUFBQSxvQkFBVSxFQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsT0FBTyxlQUFlLENBQUMsQ0FBQztJQUN2RCxNQUFNLFNBQVMsR0FBRyxtQkFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFFckQsaUNBQWlDO0lBQ2pDLElBQUksU0FBUyxFQUFFLENBQUM7UUFDZCxvQ0FBb0M7UUFDcEMsaUVBQWlFO1FBQ2pFLElBQUksbUJBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUMvQixJQUFBLHFCQUFNLEVBQUMsSUFBQSxvQkFBVSxFQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsU0FBUyxlQUFlLENBQUMsQ0FBQztZQUMzRCxPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDO1FBQ0QsOERBQThEO1FBQzlELDZCQUE2QjtRQUM3QixPQUFPLGVBQWUsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELE1BQU0sR0FBRyxHQUFHLElBQUEsdUJBQVksRUFBQyxPQUFPLENBQUMsQ0FBQztJQUNsQyxnQ0FBZ0M7SUFDaEMsZ0RBQWdEO0lBQ2hELElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUN2QixPQUFPLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQseUJBQXlCO0lBQ3pCLE9BQU8sZUFBZSxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsYUFBcUIsRUFBRSxTQUFpQjtJQUMvRCxNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQztRQUN6QixTQUFTO1FBQ1Qsd0RBQXdEO1FBQ3hELDJDQUEyQztRQUMzQyxrREFBa0Q7UUFDbEQsbUJBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLGNBQWMsQ0FBQztRQUN4QyxtQ0FBbUM7UUFDbkMsbUJBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQztLQUNuQyxDQUFDLENBQUM7SUFDSCxJQUFJLENBQUM7UUFDSCxzREFBc0Q7UUFDdEQsSUFBSSxlQUFlLENBQUM7UUFDcEIsb0RBQW9EO1FBQ3BELElBQUksYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDakUsZUFBZSxHQUFHLG1CQUFJLENBQUMsSUFBSSxDQUN6QixJQUFBLHlCQUFhLEVBQUMsR0FBRyxhQUFhLGVBQWUsQ0FBQyxFQUM5QyxVQUFVLENBQ1gsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lBQ04sZUFBZSxHQUFHLG1CQUFJLENBQUMsSUFBSSxDQUN6QixJQUFBLHlCQUFhLEVBQUMsR0FBRyxhQUFhLGVBQWUsQ0FBQyxFQUM5QyxPQUFPLENBQ1IsQ0FBQztRQUNKLENBQUM7UUFDRCxVQUFVLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsU0FBUztRQUNULEtBQUssQ0FBQyxrQ0FBa0MsRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFDRCxLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ25DLE1BQU0sYUFBYSxHQUFHLG1CQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUMxRCxJQUFJLElBQUEsb0JBQVUsRUFBQyxhQUFhLENBQUM7WUFBRSxPQUFPLGFBQWEsQ0FBQztJQUN0RCxDQUFDO0lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLGFBQWEsb0JBQW9CLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2hGLENBQUMifQ==