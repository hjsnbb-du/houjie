{"version":3,"file":"index.js","sources":["../src/SVGPickerPlugin.ts","../src/index.ts"],"sourcesContent":["import type {\n  DisplayObject,\n  GlobalRuntime,\n  PickingResult,\n  RenderingPlugin,\n  RenderingPluginContext,\n} from '@antv/g-lite';\n\n/**\n * pick shape(s) with Mouse/Touch event\n *\n * 1. find AABB with r-tree\n * 2. use elementFromPoint\n */\nexport class SVGPickerPlugin implements RenderingPlugin {\n  static tag = 'SVGPicker';\n\n  apply(context: RenderingPluginContext, runtime: GlobalRuntime) {\n    const {\n      config: { document: doc },\n      renderingService,\n      // @ts-ignore\n      svgElementMap,\n    } = context;\n\n    renderingService.hooks.pick.tapPromise(\n      SVGPickerPlugin.tag,\n      async (result: PickingResult) => {\n        return this.pick(svgElementMap, doc, result);\n      },\n    );\n\n    renderingService.hooks.pickSync.tap(\n      SVGPickerPlugin.tag,\n      (result: PickingResult) => {\n        return this.pick(svgElementMap, doc, result);\n      },\n    );\n  }\n\n  private pick(\n    svgElementMap: WeakMap<SVGElement, DisplayObject>,\n    doc: Document | ShadowRoot,\n    result: PickingResult,\n  ) {\n    const {\n      topmost,\n      position: { clientX, clientY },\n    } = result;\n\n    try {\n      const targets: DisplayObject[] = [];\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/elementsFromPoint\n      for (const element of (doc || document).elementsFromPoint(\n        clientX,\n        clientY,\n      )) {\n        if (element.shadowRoot && element.shadowRoot !== doc) {\n          return this.pick(svgElementMap, element.shadowRoot, result);\n        }\n        const target = svgElementMap.get(element as SVGElement);\n        // don't need to account for `visibility` since DOM API already does\n        if (target && target.isInteractive()) {\n          targets.push(target);\n\n          if (topmost) {\n            result.picked = targets;\n            return result;\n          }\n        }\n      }\n\n      result.picked = targets;\n    } catch {\n      result.picked = [];\n    }\n    return result;\n  }\n}\n","import { AbstractRendererPlugin } from '@antv/g-lite';\nimport { SVGPickerPlugin } from './SVGPickerPlugin';\n\nexport class Plugin extends AbstractRendererPlugin {\n  name = 'svg-picker';\n  init(): void {\n    this.addRenderingPlugin(new SVGPickerPlugin());\n  }\n  destroy(): void {\n    this.removeAllRenderingPlugins();\n  }\n}\n"],"names":["SVGPickerPlugin","_classCallCheck","_createClass","key","value","apply","context","runtime","_this","doc","config","document","renderingService","svgElementMap","hooks","pick","tapPromise","tag","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","result","wrap","_callee$","_context","prev","next","abrupt","stop","_x","arguments","pickSync","tap","topmost","_result$position","position","clientX","clientY","targets","_iterator","_createForOfIteratorHelper","elementsFromPoint","_step","s","n","done","element","shadowRoot","target","get","isInteractive","push","picked","err","e","f","_unused","Plugin","_AbstractRendererPlug","_len","length","args","Array","_key","_callSuper","concat","name","_inherits","init","addRenderingPlugin","destroy","removeAllRenderingPlugins","AbstractRendererPlugin"],"mappings":"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"}